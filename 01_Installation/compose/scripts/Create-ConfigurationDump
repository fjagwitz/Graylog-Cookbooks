#!/bin/bash
#
# Usage: 
# Create-ConfigurationDump

sudo date >/dev/null

GRAYLOG_PATH="/opt/graylog"
BACKUP_DIRECTORY="configuration_dump"
CONFIGURATION_DUMP_FILE="$(date "+%Y-%m-%d_%H-%M-%S")_GRAYLOG_CONFIGURATION_DUMP"

sudo docker compose -f ${GRAYLOG_PATH}/docker-compose.yaml exec mongodb1 mongodump --host=localhost --port=27017 --out "/${BACKUP_DIRECTORY}/${CONFIGURATION_DUMP_FILE}" --quiet
sudo tar -czf "${GRAYLOG_PATH}/${BACKUP_DIRECTORY}/${CONFIGURATION_DUMP_FILE}.tar.gz" "${GRAYLOG_PATH}/${BACKUP_DIRECTORY}/${CONFIGURATION_DUMP_FILE}" 2>/dev/null

sudo rm -rf "${GRAYLOG_PATH}/${BACKUP_DIRECTORY}/${CONFIGURATION_DUMP_FILE}"

CONFIGURATION_DUMP_FILE_SIZE=$(du -h "${GRAYLOG_PATH}/${BACKUP_DIRECTORY}/${CONFIGURATION_DUMP_FILE}.tar.gz" | cut -f1)

if [[ ${USER} == "" ]]
then
  USER="GRAYLOG SYSTEM"
fi

echo "[INFO] - GRAYLOG CONFIGURATION BACKUP (SIZE: ${CONFIGURATION_DUMP_FILE_SIZE}) SUCCESSFULLY CREATED BY ${USER^^}" 
echo "[INFO] - GRAYLOG CONFIGURATION BACKUP (SIZE: ${CONFIGURATION_DUMP_FILE_SIZE}) SUCCESSFULLY CREATED BY ${USER^^}" | logger -p user.info -e -t GRAYLOG-HELPER

NUMBER_OF_BACKUPS=$(ls -l ${GRAYLOG_PATH}/${BACKUP_DIRECTORY}/ | grep -i dump | wc -l)

while [ ${NUMBER_OF_BACKUPS} -gt 14 ]
do
  
  FILE_TO_DELETE=$(ls ${GRAYLOG_PATH}/${BACKUP_DIRECTORY}/ | grep -i dump | sort | head -n1)
  sudo rm ${GRAYLOG_PATH}/${BACKUP_DIRECTORY}/${FILE_TO_DELETE}
  NUMBER_OF_BACKUPS=$((${NUMBER_OF_BACKUPS}-1))
  
  echo "[INFO] - GRAYLOG CONFIGURATION BACKUP ${FILE_TO_DELETE} DELETED BY ${USER^^}, ${NUMBER_OF_BACKUPS} BACKUPS REMAINING"
  echo "[INFO] - GRAYLOG CONFIGURATION BACKUP ${FILE_TO_DELETE} DELETED BY ${USER^^}, ${NUMBER_OF_BACKUPS} BACKUPS REMAINING" | logger -p user.info -e -t GRAYLOG-HELPER

done

exit
